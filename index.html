<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GitHub Image Uploader</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, button, textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    textarea {
      height: 100px;
    }
  </style>
</head>
<body>
  <h1>Upload Image to GitHub</h1>
  <p>
    This application uses the URL path to determine the GitHub repository.
    If your URL does not contain repository details, default values will be used.
  </p>
  <p>
    Defaults: <strong>REPO_OWNER:</strong> ivonani, <strong>REPO_NAME:</strong> umletino-diagram-load
  </p>

  <label for="tokenInput">GitHub Token:</label>
  <input type="password" id="tokenInput" placeholder="Enter your GitHub token" />

  <label for="fileInput">Select an Image:</label>
  <input type="file" id="fileInput" accept="image/*" />

  <button id="uploadButton">Upload Image</button>

  <h2>Markdown Snippet</h2>
  <textarea id="markdownOutput" readonly></textarea>
  <button id="copyButton">Copy to Clipboard</button>

  <script>
    // --- Attempt to extract REPO_OWNER and REPO_NAME from the URL ---
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    console.log("Path parts:", pathParts);

    // Use defaults if extraction fails
    let REPO_OWNER = "ivonani";
    let REPO_NAME = "umletino-diagram-load";
    if (pathParts.length >= 2) {
      REPO_OWNER = pathParts[pathParts.length - 2];
      REPO_NAME = pathParts[pathParts.length - 1];
    } else {
      console.warn("Using default repository details.");
    }
    console.log("Using repository:", REPO_OWNER, "/", REPO_NAME);

    // --- Get references to DOM elements ---
    const tokenInput = document.getElementById("tokenInput");
    const fileInput = document.getElementById("fileInput");
    const uploadButton = document.getElementById("uploadButton");
    const markdownOutput = document.getElementById("markdownOutput");
    const copyButton = document.getElementById("copyButton");


    function uploadImage() {
      const token = tokenInput.value.trim();
      if (!token) {
        alert("Please enter your GitHub token.");
        return;
      }
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("Please select an image file.");
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const dataUrl = e.target.result;
        const base64Index = dataUrl.indexOf("base64,") + "base64,".length;
        let base64Content = dataUrl.substring(base64Index);
        // Clean the base64 string
        base64Content = base64Content.replace(/\n/g, '').trim();

        // Use the file's name as the target file path (you can also hard-code a filename)
        const FILE_PATH = file.name;
        const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
        console.log("Uploading to:", apiUrl);

        const payload = {
          message: "Upload image via Wiki Image Uploader",
          content: base64Content
        };

        fetch(apiUrl, {
          method: "PUT",
          headers: {
            "Authorization": "token " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          console.log("Upload response:", data);
          if (data.content && data.content.download_url) {
            const downloadUrl = data.content.download_url;
            // Generate the Markdown snippet for the uploaded image
            const markdownSnippet = `![${FILE_PATH}](https://${REPO_OWNER}.github.io/${REPO_NAME}/${FILE_PATH})`;
            markdownOutput.value = markdownSnippet;
            // Automatically update the wiki page with the snippet
            updateWiki(markdownSnippet, token);
          } else {
            alert("Error uploading image: " + JSON.stringify(data));
          }
        })
        .catch(err => {
          console.error(err);
          alert("Error: " + err.message);
        });
      };
      reader.readAsDataURL(file);
    }

    // --- Function to Update Wiki via GitHub API ---
    function updateWiki(markdownSnippet, token) {
      // The wiki repository is typically named as {REPO_NAME}.wiki
      const wikiRepo = `${REPO_OWNER}/${REPO_NAME}.wiki`;
      // Define the wiki page to update (e.g., Diagram.md)
      const pagePath = "Diagram.md";
      const url = `https://api.github.com/repos/${wikiRepo}/contents/${pagePath}`;
      // Base64-encode the markdown snippet
      const base64Content = btoa(markdownSnippet);
      
      // First, try to GET the file to see if it exists (to get the current sha)
      fetch(url, {
        headers: {
          "Authorization": "token " + token
        }
      })
      .then(response => {
        if (response.status === 200) {
          return response.json();
        } else if (response.status === 404) {
          return null;
        } else {
          throw new Error("Error checking wiki file: " + response.status);
        }
      })
      .then(data => {
        const payload = {
          message: "Update wiki with diagram markdown",
          content: base64Content
        };
        if (data && data.sha) {
          payload.sha = data.sha;
        }
        // Update (or create) the wiki page
        return fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": "token " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });
      })
      .then(response => response.json())
      .then(data => {
        console.log("Wiki update response:", data);
        if (data.content && data.content.download_url) {
          alert("Wiki updated! You can view it at: " + data.content.download_url);
        } else {
          alert("Error updating wiki: " + JSON.stringify(data));
        }
      })
      .catch(err => {
        console.error("Error updating wiki:", err);
        alert("Error updating wiki: " + err.message);
      });
    }

    // --- Attach event listeners ---
    uploadButton.addEventListener("click", uploadImage);

    // --- Upload Button Click Handler ---
    /*uploadButton.addEventListener("click", () => {
      const token = tokenInput.value.trim();
      if (!token) {
        alert("Please enter your GitHub token.");
        return;
      }
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("Please select an image file.");
        return;
      }
      const file = fileInput.files[0];

      const reader = new FileReader();
      reader.onload = function(e) {
        // e.target.result is a Data URL (e.g., "data:image/png;base64,...")
        const dataUrl = e.target.result;
        // Extract base64 content from Data URL:
        const base64Index = dataUrl.indexOf("base64,") + "base64,".length;
        const base64Content = dataUrl.substring(base64Index);
        base64Content = base64Content.replace(/\n/g, '').trim();
        
        // Use the file's name for the file path
        const FILE_PATH = file.name;
        const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
        //const apiUrl = `https://${REPO_OWNER}.github.io/${REPO_NAME}/${FILE_PATH}`;
        //https://${username}.github.io/umletino-diagram-load/diagram.png
        console.log("API URL:", apiUrl);
        
        // Prepare payload for GitHub API:
        const payload = {
          message: "Upload image via GitHub Image Uploader",
          content: base64Content
        };

        // Send PUT request to GitHub API:
        fetch(apiUrl, {
          method: "PUT",
          headers: {
            "Authorization": "token " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          console.log(data);
          if (data.content && data.content.download_url) {
            const downloadUrl = data.content.download_url;
            //const urlObj = new URL(downloadUrl);
            //const pathParts = urlObj.pathname.split('/'); // [ "", "ivonani", "umletino-diagram-load", "main", "image.png" ]
            //const relativePath = pathParts.slice(2).join('/'); // "umletino-diagram-load/main/image.png"
            // Generate Markdown snippet:
            //const markdownSnippet = `![${FILE_PATH}](${downloadUrl})`;
            const markdownSnippet = `![${FILE_PATH}](https://${REPO_OWNER}.github.io/${REPO_NAME}/${FILE_PATH})`;
            //(https://${username}.github.io/umletino-diagram-load/diagram.png)
            markdownOutput.value = markdownSnippet;
          } else {
            alert("Error uploading image: " + JSON.stringify(data));
          }
        })
        .catch(err => {
          alert("Error: " + err.message);
          console.error(err);
        });
      };
      reader.readAsDataURL(file);
    });*/

    // --- Copy to Clipboard Button ---
    copyButton.addEventListener("click", () => {
      markdownOutput.select();
      document.execCommand("copy");
      alert("Markdown snippet copied to clipboard!");
    });
  </script>
</body>
</html>